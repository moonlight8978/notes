---
title: AWS X-Ray
code: https://github.com/moonlight8978/aws-cda-preparation/tree/xray
---

* To analyze and debug **microservice** system
* X-Ray is a distributed tracing system

*  Alternative apps - Cloud Monitoring / Application Performance Monitoring Services (APMs): Datadog, New Relic, ...

# Definitions

* Distributed Tracing
  * aka Distributed request tracing
  * Is a method used to profile and monitor app (espicially microservices architecture app)
  * Helps pinpoint wher failures occur and what causes poor performance
* Performance Monitoring:
  * Monitor and management of performance and availability of software apps
* Instrumenting:
  * The ability to monitor/measure product performance, to diagnose errors, and write trace information

# Anatomy

![](https://images.viblo.asia/ff0d7b62-cfb9-45a7-b6da-033d32ca9b80.png)

#### X-Ray SDK

* **Interceptors** to trace incoming HTTP requests
* **Client handlers** to instrument calls to other AWS Services
* **HTTP Client** to instrument calls to other internal or external HTTP web services

```js
const app = express()
const AWSXRay = require('aws-xray-sdk')

app.use(AWSXRay.express.openSegment("MyApp"))

app.get("/", (req, res) => res.render('index'))

app.use(AWSXRay.express.closeSegment())
```

#### X-Ray Daemon

- SDK sends JSON segment documents to a daemon running in instances (or something) (UDP traffic)
- Upload documents to X-Ray in batches

# Concepts

* X-Ray receives services data as **segments**
* X-Ray groups segments that have a common request into **traces**
* X-Ray process the traces to generate **service graph**

# TODO

Build a RoR application using container, deploy to EC2 using docker-compose.

* External: MySQL (RDS), S3
* Features: 
  * Sign up, login
  * CRUD users
  * User login history
  * User avatar
* Basic auth

Apply X-Ray to monitor the app

# Components

#### Segments

* Request/Response details: Hostname, IP, Origin, Duration, ...
* Segment ID

#### Subsegments

* Provide more information about downstream calls to fulfill the original request
  * HTTP request to other API
  * Database query
  * ...

![](https://images.viblo.asia/c2505efb-4bbe-4246-8465-a88c7453b490.png)

* Arbitrary subsegments can be defined to instrument specific functions

#### Trace

* Trace ID
* Collect all segments generated by a single request

#### Sampling

* Use a **sampling algorithm** to determine which requests get traces

* Default sampling rule: The first request each second, and 5% of any additional requests

  => Reduce the amount of traces => Save money

#### Trace Header

* All requests are traced, up to a configurable minimum

  After reaching that minimum, a percentage of requests are traced (to void unnecessary cost)

  The sampling decision and trace ID are added to HTTP request (called tracing headers) - **X-Amzn-Trace-Id**

#### Filter expression

* Allow to narrow down specific paths or users

#### Groups

- Allow save FilterExpressions to filter traces quickly

#### Annotations and Metadata

* Extra data can be added to segment document as annotation and metadata
* Annotations and metadata are aggregated at the trace level
* Annotation are indexed for use with filter expressions => Use filter expression to gruop traces
  * Up to 50 annotations per trace
* Metadata are not indexed

#### Errors, faults, and Exceptions

* Errors: 400/4XX errors
* Fault: 500/5XX errors
* Throttle: 429 Too Many Requests



